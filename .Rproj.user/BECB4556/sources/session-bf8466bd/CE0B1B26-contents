# Load sensitive configuration. This file should never be committed.
setwd('~/Respiratory_viruses_weekly_data/')
source('config.R')
source('download_data.R')
source('sql_utils.R')
source('logger.R')
library(tidyverse)
library(glue)

Logger = forgeLogger(exec_guid = 'character', step = 'character', process = 'character')
assign("logger", Logger(log_level = 'DEBUG',
                        step = 'MPP',
                        process = 'Setup',
                        file_output = T,
                        filename = paste0('log/transfer_PROD_', Sys.Date(), '.log'),
                        exec_guid = stringi::stri_c(Sys.time(), " - Test"),
                        memory_monitor = T),
       envir = .GlobalEnv)

dbDir <- '~/conmaster/'
snapshotDate = if(lubridate::wday(Sys.Date(), week_start = 1) == 5) Sys.Date() else if(lubridate::wday(Sys.Date(), week_start = 1) == 1) Sys.Date() - 3 else stop("Please introduce a manual date that coincides with the Friday of the issue date")
previousSnapshotDate = snapshotDate-7
tables <- c('ILIARIRates', 
            'activityFluTypeSubtype', 
            'sentinelTestsDetectionsPositivity', 
            'nonSentinelTestsDetections',
            'nonSentinelSeverity', 
            'variants',
            'sequencingVolumeDetectablePrevalence')

source('sql_utils.R')

create_ECDC_data_downloads(tables = tables,
                           snapshotDate = snapshotDate) 

# Add to git
system("git add data/*.csv")
system("git add data/snapshots/*.csv")
system("git add README.MD")
system(paste0('git commit -m "',
              'commit_as_of_',
              snapshotDate, 
              '"'))

masterdf <- lapply(tables, function(x){
  newOne <- vroom::vroom(str_c('data/', x, '.csv'))
  oldOne <- vroom::vroom(str_c('data/snapshots/', previousSnapshotDate, '_', x, '.csv'),
                         col_select = 'yearweek')
  data.frame(list(name = x,
                  oldRows = nrow(oldOne),
                  newRows = nrow(newOne),
                  diffRows = nrow(newOne)-nrow(oldOne),
                  oldLatestWeek = max(oldOne$yearweek),
                  newLatestWeek = max(newOne$yearweek)))
}) %>%
  bind_rows()

msg = glue("
  <p>Dear colleagues,</p><br>
  <p>ERVISS data has just been pushed to the Github repository. Please check
     the following table with a summary of the new files and the old ones:</p>
  <table>
    <tr>
      {paste0('<th>', colnames(masterdf), '</th>', collapse = '\n')}
    </tr>
    <tr>
      {paste0('<td>', masterdf$name,'</td><td>',  masterdf$oldRows,'</td><td>', masterdf$newRows,'</td><td>', masterdf$oldLatestWeek,'</td><td>', masterdf$newLatestWeek, '</td>', collapse = '</tr><tr>\n')}
    </tr>
  </table>
  <p>Please don't hesitate to reach out to the ERVISS team in case there is something amiss. </p>
  <p>Kind regards,</p>
  <p>ERVISS Team</p>
")



# Push it to the repository
system("git push")

send_email(sbj = 'ERVISS data has been pushed', msg = msg)

